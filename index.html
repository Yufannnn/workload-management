<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#0b0f14">

  <!-- Social preview -->
  <meta property="og:title" content="Workload Management" />
  <meta property="og:description" content="Up to 3 people at a time. Start/Stop to claim a slot." />
  <meta property="og:image" content="site-og-1200x630.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workload Management â€” 3 concurrent max</title>

  <style>
    :root {
      --card:#101418; --ink:#e7eaee; --muted:#a6a8ad; --accent:#5eead4; --danger:#fca5a5; --ok:#86efac; --bg:#0b0f14;
      --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      --usage: 0; /* 0..1 set by JS */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:
        radial-gradient(1100px 650px at 15% 8%, rgba(94,234,212,.07), transparent 60%),
        radial-gradient(900px 500px at 85% 92%, rgba(134,239,172,.06), transparent 60%),
        linear-gradient(180deg, #0b0f14, #0a0e12);
      color:var(--ink); display:flex; align-items:center; justify-content:center; padding:24px
    }
    .app{width:100%; max-width:780px; background:var(--card); border:1px solid #1c2128; border-radius:var(--radius); padding:22px; box-shadow:var(--shadow)}
    h1{margin:0 0 8px; font-size:22px; letter-spacing:.2px}
    p{margin:6px 0; color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px}
    @media (min-width:720px){ .grid{grid-template-columns:2fr 1fr} }
    .card{background:#0f141a; border:1px solid #1e252d; border-radius:12px; padding:14px}
    label{display:block; margin-bottom:6px; color:var(--muted); font-size:14px}
    select,button{width:100%; padding:12px; border-radius:12px; border:1px solid #24303b; background:#0b1117; color:var(--ink); font-size:15px}
    button{cursor:pointer; transition:transform .02s ease, filter .15s ease, box-shadow .15s ease}
    button:hover{filter:brightness(1.12)}
    button:active{transform:translateY(0.5px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    #start{background:linear-gradient(180deg,#0f1b22,#0b1117); border-color:#23313d; box-shadow:0 0 0 0 rgba(94,234,212,.0)}
    #start:not(:disabled):focus-visible,#start:not(:disabled):hover{box-shadow:0 0 0 3px rgba(94,234,212,.20)}
    #stop{background:linear-gradient(180deg,#191216,#0f0b0d)}
    .row{display:flex; gap:10px}
    .grow{flex:1}

    .pill{position:relative; display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#0b1117; border:1px solid #24303b; font-size:14px; overflow:hidden}
    .pill::before{content:""; position:absolute; inset:0; width:calc(var(--usage) * 100%); background:linear-gradient(90deg, rgba(94,234,212,.12), rgba(134,239,172,.10)); pointer-events:none}
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.green{background:var(--ok); box-shadow:0 0 12px rgba(134,239,172,.45)}
    .dot.red{background:var(--danger); box-shadow:0 0 10px rgba(252,165,165,.4)}

    ul{list-style:none; margin:8px 0 0; padding:0; display:flex; flex-wrap:wrap; gap:8px}
    .name{padding:8px 12px; border-radius:10px; background:#0c1218; border:1px solid #1f2a35; transition:all .15s ease}
    .name.on{outline:1px solid rgba(94,234,212,.35); background:#0e171f}

    .muted{color:var(--muted)}
    .accent{color:var(--accent)}
    .foot{margin-top:16px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:13px}

    .err{color:var(--danger)}
    .ok{color:var(--ok)}
    .hint{font-size:12px}

    /* Toast */
    .toast{position:fixed; left:50%; bottom:28px; transform:translateX(-50%) translateY(20px); background:#0e141a; color:var(--ink); border:1px solid #23313d; border-radius:12px; padding:10px 14px; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease; box-shadow:var(--shadow); max-width:86vw}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .toast.err{border-color:#3a1d22; background:#120b0d; color:#ffd6d6}
    .toast.ok{border-color:#20342c; background:#0e1613}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Server usage tracker">
    <h1>Workload Management</h1>
    <p>Up to <span class="accent"><strong id="max">3</strong></span> people can use the server at once. Pick your name, then press <em>Start using</em> / <em>Stop</em>.</p>

    <div class="grid">
      <div class="card">
        <label for="who">Your name</label>
        <select id="who" aria-label="Choose your name"></select>
        <div class="row" style="margin-top:10px">
          <button id="start" class="grow" aria-live="polite">Start using</button>
          <button id="stop" class="grow">Stop</button>
        </div>
        <p id="msg" class="hint"></p>
      </div>

      <div class="card">
        <div class="pill" title="Current occupancy">
          <span id="status-dot" class="dot red"></span>
          <strong><span id="count">0</span>/<span id="limit">3</span></strong> using now
        </div>
        <ul id="active-list" aria-live="polite" aria-label="Currently using"></ul>
        <p class="hint muted">Updates in real time for everyone.</p>
      </div>
    </div>

    <div class="foot">
      <span class="muted">Tip: keep this tab open while you're using; click <em>Stop</em> when you finish.</span>
      <span class="muted">Built with GitHub Pages + Firebase (Firestore).</span>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase (compat builds keep the code succinct) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===================== SETTINGS =====================
    // Your Firebase web app config:
    const firebaseConfig = {
      apiKey: "AIzaSyAKS3Zmv__4RyRfCE4phJRf5U-JSqPy_78",
      authDomain: "workload-management-9af9f.firebaseapp.com",
      projectId: "workload-management-9af9f",
      storageBucket: "workload-management-9af9f.firebasestorage.app",
      messagingSenderId: "200955908281",
      appId: "1:200955908281:web:ff31a9850ef28f121bb2e8"
    };

    // Team roster
    const MEMBERS = ["Deqi", "Sijia", "Yufan", "Yuqing", "Zeyu"];
    const MAX_CONCURRENT = 3;
    // ====================================================

    // Init Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const statusRef = db.collection("usage").doc("status");

    // DOM helpers
    const $ = (q) => document.querySelector(q);
    const whoSel = $("#who");
    const startBtn = $("#start");
    const stopBtn = $("#stop");
    const countEl = $("#count");
    const limitEls = [$("#limit"), $("#max")];
    const dot = $("#status-dot");
    const list = $("#active-list");
    const msg = $("#msg");
    const toastEl = $("#toast");

    // Populate names
    function populateNames(){
      whoSel.innerHTML = MEMBERS.map(n => `<option value="${n}">${n}</option>`).join("");
      limitEls.forEach(el => el.textContent = MAX_CONCURRENT);
    }
    populateNames();

    // Ensure doc exists
    statusRef.get().then(snap => { if(!snap.exists){ statusRef.set({ active: [] }); } });

    // Live listener
    let activeCache = [];
    let isBusy = false; // blocks double-clicks during transactions

    statusRef.onSnapshot((snap) => {
      const data = snap.data() || { active: [] };
      const active = Array.isArray(data.active) ? data.active : [];
      activeCache = active;

      // Update occupancy UI
      countEl.textContent = active.length;
      const ratio = active.length / MAX_CONCURRENT;
      document.documentElement.style.setProperty('--usage', String(ratio));
      dot.classList.toggle('green', active.length > 0 && active.length < MAX_CONCURRENT);
      dot.classList.toggle('red', active.length >= MAX_CONCURRENT || active.length === 0);

      // Render active list (highlight your name)
      const me = whoSel.value;
      list.innerHTML = active.length
        ? active.map(n => `<li class="name ${n===me ? 'on' : ''}">${n}</li>`).join("")
        : '<li class="muted">Nobody is using the server.</li>';

      // Update buttons
      const iAmUsing = active.includes(me);
      startBtn.disabled = iAmUsing || active.length >= MAX_CONCURRENT;
      stopBtn.disabled = !iAmUsing;

      // Message
      if (active.length >= MAX_CONCURRENT && !iAmUsing) {
        setMsg(`Server is full (${active.length}/${MAX_CONCURRENT}).`, true);
      } else {
        setMsg('', false);
      }
    });

    // Keep UI in sync when the selected name changes
    whoSel.addEventListener('change', () => {
      const me = whoSel.value;
      const iAmUsing = activeCache.includes(me);
      startBtn.disabled = iAmUsing || activeCache.length >= MAX_CONCURRENT;
      stopBtn.disabled = !iAmUsing;
      // Highlight me
      list.innerHTML = activeCache.length
        ? activeCache.map(n => `<li class="name ${n===me ? 'on' : ''}">${n}</li>`).join("")
        : list.innerHTML;
      msg.textContent = '';
    });

    // Transaction: try to add me if capacity allows
    async function startUsing() {
      const me = whoSel.value;

      // prevent double-clicks
      if (isBusy) return;
      isBusy = true;
      startBtn.disabled = true;

      try {
        // quick client-side checks + heads up
        if (activeCache.includes(me)) {
          setMsg('You are already marked as USING.', false);
          return;
        }
        if (activeCache.length >= MAX_CONCURRENT) {
          setMsg(`Cannot start: server is full (${activeCache.length}/${MAX_CONCURRENT}).`, true);
          alert(`Server is full (${activeCache.length}/${MAX_CONCURRENT}). Please try again later.`);
          return;
        }
        if (activeCache.length === MAX_CONCURRENT - 1) {
          setMsg('Heads-up: last slot â€” checkingâ€¦', false);
        } else {
          setMsg('Reserving a slotâ€¦', false);
        }

        await db.runTransaction(async (tx) => {
          const doc = await tx.get(statusRef);
          const data = doc.exists ? doc.data() : { active: [] };
          const active = Array.from(new Set((data.active || []).filter(Boolean)));

          if (active.includes(me)) return;         // already using (no-op)
          if (active.length >= MAX_CONCURRENT) {
            throw new Error('FULL');               // someone else filled it
          }

          active.push(me);
          tx.set(statusRef, { active }, { merge: true });
        });

        setMsg('You are now marked as USING. âœ…', false);

        // Optimistic UI until the realtime snapshot arrives
        activeCache = Array.from(new Set([...activeCache, me]));
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (e) {
        if (e.message === 'FULL') {
          setMsg(
            `Someone else grabbed the last slot. Server is full (${activeCache.length}/${MAX_CONCURRENT}).`,
            true
          );
          alert('Server just became full. Please try again later.');
        } else {
          setMsg('Something went wrong. Please try again.', true);
          console.error(e);
        }
      } finally {
        isBusy = false;
      }
    }

    // Transaction: remove me if present
    async function stopUsing(){
      const me = whoSel.value;
      try {
        await db.runTransaction(async (tx) => {
          const doc = await tx.get(statusRef);
          const data = doc.exists ? doc.data() : { active: [] };
          let active = Array.from(new Set((data.active || []).filter(Boolean)));
          if (!active.includes(me)) return; // already not using
          active = active.filter(n => n !== me);
          tx.set(statusRef, { active }, { merge: true });
        });
        setMsg('You are now marked as NOT USING. âœ‹', false);
      } catch (e) {
        setMsg('Something went wrong. Please try again.', true);
        console.error(e);
      }
    }

    startBtn.addEventListener('click', startUsing);
    stopBtn.addEventListener('click', stopUsing);

    // Best-effort: auto mark NOT USING when the tab closes
    window.addEventListener('beforeunload', () => { try { stopUsing(); } catch (_) {} });

    function setMsg(text, isErr){
      msg.textContent = text;
      msg.className = 'hint ' + (isErr ? 'err' : 'ok');
      if (!text) { toastEl.classList.remove('show','ok','err'); return; }
      showToast(text, isErr ? 'err' : 'ok');
    }

    let toastTimer;
    function showToast(text, kind='ok'){
      if (!toastEl) return;
      toastEl.textContent = text;
      toastEl.classList.remove('ok','err');
      toastEl.classList.add('show', kind);
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toastEl.classList.remove('show'); }, 2200);
    }
  </script>
</body>
</html>
